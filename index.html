<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recruit 101</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0b0b0b">
  <link rel="icon" href="./assets/icon.png">
  <style>
    html,body { background:#0b0b0b; color:#e5e7eb; }
    .card { background:#1f2937; }
    select, input { background:#0b0b0b; }
    a.btn, button.btn { background:#e11d48; color:white; }
    .muted { color:#9ca3af; }
    table th, table td { white-space: nowrap; }
    .btn-ghost { background:#374151; color:#e5e7eb; }
    .btn-lite { background:#4b5563; color:white; }
    .btn-lite[disabled] { opacity:0.4; cursor:not-allowed; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-7xl mx-auto p-4 space-y-4">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="./assets/logo.png" alt="Recruit 101" class="h-10 w-auto rounded-md" />
        <h1 class="text-xl font-semibold">Recruit 101</h1>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm">After-send status</label>
        <select id="afterStatus" class="rounded-md p-2">
          <option value="To Contact" >To Contact</option>
<option value="Whatsapp" selected>Whatsapp</option>
<option value="Reply" >Reply</option>
<option value="Keen to meet" >Keen to meet</option>
<option value="Cultivate" >Cultivate</option>
<option value="Invite to events" >Invite to events</option>
<option value="Not interested" >Not interested</option>
<option value="No Whatsapp" >No Whatsapp</option>
<option value="Unsubscribe" >Unsubscribe</option>
<option value="Referred" >Referred</option>
        </select>
        <button id="btnRefresh" class="btn px-3 py-2 rounded-md">Refresh</button>
      </div>
    </header>

    <!-- Bulk controls -->
    <section class="card rounded-xl p-3">
      <div class="grid md:grid-cols-3 gap-3 items-end">
        <div>
          <label class="text-sm block mb-1">Bulk Message Type</label>
          <select id="bulkType" class="rounded-md p-2 w-full"><option value="Recruit">Recruit</option>
<option value="Event 1 - Win Win">Event 1 - Win Win</option></select>
        </div>
        <div class="flex gap-2">
          <button id="btnApplyBulk" class="btn px-3 py-2 rounded-md">Apply to Selected</button>
          <button id="btnClearSel" class="btn-ghost px-3 py-2 rounded-md">Clear Selection</button>
        </div>
        <div class="text-sm muted flex items-center gap-2">
          Selected: <span id="selCount">0</span>
          <span id="progress" class="text-xs muted"></span>
        </div>
      </div>
    </section>

    <section class="card rounded-xl p-3">
      <div class="overflow-auto">
        <table class="w-full text-sm">
          <thead class="text-xs uppercase muted">
            <tr class="border-b border-neutral-700">
              <th class="p-2 text-left"><input type="checkbox" id="checkAll"></th>
              <th class="p-2 text-left">Message Type</th>
              <th class="p-2 text-left">Status</th>
              <th class="p-2 text-left">WhatsApp</th>
              <th class="p-2 text-left">Name</th>
              <th class="p-2 text-left">Surname</th>
              <th class="p-2 text-left">Number</th>
              <th class="p-2 text-left">Agency</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex items-center justify-between mt-3">
        <div class="text-xs muted">Showing 15 per page</div>
        <div class="flex items-center gap-2">
          <button id="prevPage" class="btn-lite px-3 py-2 rounded-md">Prev</button>
          <span id="pageInfo" class="text-sm"></span>
          <button id="nextPage" class="btn-lite px-3 py-2 rounded-md">Next</button>
        </div>
      </div>

      <p class="muted text-xs mt-2">Use bulk to change Message Type for many rows at once. Per-row changes also work.</p>
    </section>
  </div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby4SK5f2I8m3wwqIfItGxUXzHWeJHxkT0OqxRQn6TtylzQ6TqG0TBHpMfZhtQPTFhUIHw/exec";
  const MESSAGE_TYPES = ["Recruit", "Event 1 - Win Win"];
  const STATUS_OPTIONS = ["To Contact", "Whatsapp", "Reply", "Keen to meet", "Cultivate", "Invite to events", "Not interested", "No Whatsapp", "Unsubscribe", "Referred"];

  const PAGE_SIZE = 15;
  let currentPage = 1;

  const el = (id) => document.getElementById(id);
  let rowsData = [];
  let selected = new Set(); // holds backend rowIndex values across pages

  function setSelCount(){ el('selCount').textContent = selected.size; }
  function setProgress(msg){ el('progress').textContent = msg || ''; }

  function totalPages(){ return Math.max(1, Math.ceil(rowsData.length / PAGE_SIZE)); }
  function clampPage(){ if (currentPage < 1) currentPage = 1; if (currentPage > totalPages()) currentPage = totalPages(); }
  function pageSlice(){
    const start = (currentPage - 1) * PAGE_SIZE;
    return rowsData.slice(start, start + PAGE_SIZE);
  }
  function updatePagerUI(){
    clampPage();
    el('pageInfo').textContent = 'Page ' + currentPage + ' of ' + totalPages();
    el('prevPage').disabled = (currentPage <= 1);
    el('nextPage').disabled = (currentPage >= totalPages());
  }

  async function fetchRecipients() {
    const url = new URL(WEB_APP_URL);
    url.searchParams.set('action','recipients');
    url.searchParams.set('t', Date.now()); // cache-buster
    const res = await fetch(url.toString());
    const js = await res.json();
    rowsData = js.recipients || [];
    clampPage();
    renderTable();
    updatePagerUI();
    setSelCount();
  }

  async function postAction(action, payload){
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action, payload })
    });
    if (!res.ok) throw new Error('HTTP '+res.status);
    let js = null;
    try { js = await res.json(); } catch(e) {}
    if (js && js.result === 'error') throw new Error(js.message||'Server error');
    return js || {result:'ok'};
  }

  async function updateMessageType(rowIndex, newType) {
    return postAction('updateMessageType', { rowIndex, newType });
  }
  async function bulkUpdateMessageType(rowIndices, newType) {
    return postAction('bulkUpdateMessageType', { rowIndices, newType });
  }
  async function updateStatus(rowIndex, newStatus) {
    return postAction('updateSingleStatus', { rowIndex, newStatus });
  }

  function selectHtml(opts, current) {
    let html = '<select class="rounded-md p-1">';
    for (const o of opts) {
      const sel = (o === current) ? 'selected' : '';
      html += '<option value="'+o+'" '+sel+'>'+o+'</option>';
    }
    html += '</select>';
    return html;
  }

  function renderTable() {
    const tb = el('rows'); tb.innerHTML = '';
    const visible = pageSlice();

    visible.forEach((r) => {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-neutral-800';

      // Checkbox reflecting global selection by rowIndex
      const tdChk = document.createElement('td'); tdChk.className='p-2';
      const chk = document.createElement('input'); chk.type='checkbox'; chk.checked = selected.has(r.rowIndex);
      chk.addEventListener('change', () => {
        if (chk.checked) selected.add(r.rowIndex); else selected.delete(r.rowIndex);
        setSelCount();
        wireCheckAllState();
      });
      tdChk.appendChild(chk);

      // Message Type select
      const tdType = document.createElement('td'); tdType.className='p-2';
      tdType.innerHTML = selectHtml(MESSAGE_TYPES, r.messageType || 'Recruit');
      const selType = tdType.querySelector('select');
      selType.addEventListener('change', async (e) => {
        selType.disabled = true;
        try { await updateMessageType(r.rowIndex, e.target.value); } catch(e){ console.error(e); }
        await fetchRecipients();
      });

      // Status select
      const tdStatus = document.createElement('td'); tdStatus.className='p-2';
      tdStatus.innerHTML = selectHtml(STATUS_OPTIONS, r.status || '');
      const selStatus = tdStatus.querySelector('select');
      selStatus.addEventListener('change', async (e) => {
        selStatus.disabled = true;
        try { await updateStatus(r.rowIndex, e.target.value); } catch(e){ console.error(e); }
        await fetchRecipients();
      });

      // WhatsApp button
      const tdWA = document.createElement('td'); tdWA.className='p-2';
      if (r.waLink) {
        const a = document.createElement('a');
        a.className = 'btn px-3 py-1 rounded-md';
        a.textContent = 'Send';
        a.href = r.waLink;
        a.target = '_blank';
        a.addEventListener('click', async () => {
          const st = el('afterStatus').value || 'Whatsapp';
          try { await updateStatus(r.rowIndex, st); } catch (e) {}
        });
        tdWA.appendChild(a);
      } else {
        const span = document.createElement('span');
        span.className = 'muted text-xs';
        span.textContent = 'No link';
        tdWA.appendChild(span);
      }

      const tdName = document.createElement('td'); tdName.className='p-2'; tdName.textContent = r.name || '';
      const tdSur  = document.createElement('td'); tdSur.className='p-2'; tdSur.textContent  = r.surname || '';
      const tdNum  = document.createElement('td'); tdNum.className='p-2'; tdNum.textContent  = r.cell || '';
      const tdAg   = document.createElement('td'); tdAg.className='p-2'; tdAg.textContent   = r.agency || '';

      tr.appendChild(tdChk);
      tr.appendChild(tdType);
      tr.appendChild(tdStatus);
      tr.appendChild(tdWA);
      tr.appendChild(tdName);
      tr.appendChild(tdSur);
      tr.appendChild(tdNum);
      tr.appendChild(tdAg);

      tb.appendChild(tr);
    });

    wireCheckAllState();
  }

  function wireCheckAllState(){
    const visible = pageSlice();
    const checkAll = document.getElementById('checkAll');
    const allSelectedOnPage = visible.length > 0 && visible.every(r => selected.has(r.rowIndex));
    checkAll.checked = allSelectedOnPage;
    checkAll.onchange = (e) => {
      if (e.target.checked) {
        for (const r of visible) selected.add(r.rowIndex);
      } else {
        for (const r of visible) selected.delete(r.rowIndex);
      }
      renderTable();
      setSelCount();
    };
  }

  document.addEventListener('DOMContentLoaded', () => {
    el('btnApplyBulk').onclick = async () => {
      if (selected.size === 0) { alert('Select at least one row.'); return; }
      const newType = el('bulkType').value;
      const targets = Array.from(selected);

      setProgress('Applying…');
      try {
        await bulkUpdateMessageType(targets, newType);
      } catch (e) {
        console.warn('bulkUpdateMessageType not available, falling back per-row.', e);
        let done = 0;
        for (const ri of targets) {
          try { await updateMessageType(ri, newType); } catch(e){ console.error(e); }
          done++; setProgress('Applying… '+done+'/'+targets.length);
        }
      }
      setProgress('');
      await fetchRecipients();
    };

    el('btnClearSel').onclick = () => { selected.clear(); renderTable(); setSelCount(); };
    el('btnRefresh').onclick = () => { currentPage = 1; fetchRecipients(); };
    el('prevPage').onclick = () => { currentPage--; clampPage(); renderTable(); updatePagerUI(); };
    el('nextPage').onclick = () => { currentPage++; clampPage(); renderTable(); updatePagerUI(); };
  });

  fetchRecipients();
</script>
</body>
</html>
