<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recruit 101</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0b0b0b">
  <link rel="icon" href="./assets/icon.png">
  <style>
    html,body { background:#0b0b0b; color:#e5e7eb; }
    .card { background:#1f2937; }
    select, input { background:#0b0b0b; }
    a.btn, button.btn { background:#e11d48; color:white; }
    .muted { color:#9ca3af; }
    table th, table td { white-space: nowrap; }
    .btn-ghost { background:#374151; color:#e5e7eb; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-7xl mx-auto p-4 space-y-4">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="./assets/logo.png" alt="Recruit 101" class="h-10 w-auto rounded-md" />
        <h1 class="text-xl font-semibold">Recruit 101</h1>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm">After-send status</label>
        <select id="afterStatus" class="rounded-md p-2">
          <option value="To Contact" >To Contact</option>
<option value="Whatsapp" selected>Whatsapp</option>
<option value="Reply" >Reply</option>
<option value="Keen to meet" >Keen to meet</option>
<option value="Cultivate" >Cultivate</option>
<option value="Invite to events" >Invite to events</option>
<option value="Not interested" >Not interested</option>
<option value="No Whatsapp" >No Whatsapp</option>
<option value="Unsubscribe" >Unsubscribe</option>
<option value="Referred" >Referred</option>
        </select>
        <button id="btnRefresh" class="btn px-3 py-2 rounded-md">Refresh</button>
      </div>
    </header>

    <section class="card rounded-xl p-3">
      <div class="grid md:grid-cols-3 gap-3 items-end">
        <div>
          <label class="text-sm block mb-1">Bulk Message Type</label>
          <select id="bulkType" class="rounded-md p-2 w-full"><option value="Recruit">Recruit</option>
<option value="Event 1 - Win Win">Event 1 - Win Win</option></select>
        </div>
        <div class="flex gap-2">
          <button id="btnApplyBulk" class="btn px-3 py-2 rounded-md">Apply to Selected</button>
          <button id="btnClearSel" class="btn-ghost px-3 py-2 rounded-md">Clear Selection</button>
        </div>
        <div class="text-sm muted">Selected: <span id="selCount">0</span></div>
      </div>
    </section>

    <section class="card rounded-xl p-3">
      <div class="overflow-auto">
        <table class="w-full text-sm">
          <thead class="text-xs uppercase muted">
            <tr class="border-b border-neutral-700">
              <th class="p-2 text-left"><input type="checkbox" id="checkAll"></th>
              <th class="p-2 text-left">Message Type</th>
              <th class="p-2 text-left">Status</th>
              <th class="p-2 text-left">WhatsApp</th>
              <th class="p-2 text-left">Name</th>
              <th class="p-2 text-left">Surname</th>
              <th class="p-2 text-left">Number</th>
              <th class="p-2 text-left">Agency</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <p class="muted text-xs mt-2">Change Message Type or Status, then click <b>Send</b>. Use the bulk controls above to set Message Type for many rows at once.</p>
    </section>
  </div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzvl9L9Sg52CJYJ_m5NnuSCgFmQevxch5ym-7zT1MF43DPldvBJfTYuT9EpHnAcleTs0w/exec";
  const MESSAGE_TYPES = ["Recruit", "Event 1 - Win Win"];
  const STATUS_OPTIONS = ["To Contact", "Whatsapp", "Reply", "Keen to meet", "Cultivate", "Invite to events", "Not interested", "No Whatsapp", "Unsubscribe", "Referred"];

  const el = (id) => document.getElementById(id);
  let rowsData = [];
  let selected = new Set();

  function setSelCount(){ el('selCount').textContent = selected.size; }

  async function fetchRecipients() {
    const url = new URL(WEB_APP_URL);
    url.searchParams.set('action','recipients');
    const res = await fetch(url.toString());
    const js = await res.json();
    rowsData = js.recipients || [];
    selected.clear();
    renderTable();
    setSelCount();
  }

  async function updateMessageType(rowIndex, newType) {
    await fetch(WEB_APP_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        action:'updateMessageType',
        payload: { rowIndex, newType }
      })
    });
  }

  async function updateStatus(rowIndex, newStatus) {
    await fetch(WEB_APP_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        action:'updateSingleStatus',
        payload: { rowIndex, newStatus }
      })
    });
  }

  function selectHtml(opts, current) {
    let html = '<select class="rounded-md p-1">';
    for (const o of opts) {
      const sel = (o === current) ? 'selected' : '';
      html += `<option value="${o}" ${sel}>${o}</option>`;
    }
    html += '</select>';
    return html;
  }

  function renderTable() {
    const tb = el('rows'); tb.innerHTML = '';
    rowsData.forEach((r, i) => {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-neutral-800';

      const tdChk = document.createElement('td'); tdChk.className='p-2';
      const chk = document.createElement('input'); chk.type='checkbox'; chk.checked = selected.has(i);
      chk.addEventListener('change', () => { if (chk.checked) selected.add(i); else selected.delete(i); setSelCount(); });
      tdChk.appendChild(chk);

      const tdType = document.createElement('td'); tdType.className='p-2';
      tdType.innerHTML = selectHtml(MESSAGE_TYPES, r.messageType || 'Recruit');
      const selType = tdType.querySelector('select');
      selType.addEventListener('change', async (e) => {
        selType.disabled = true;
        await updateMessageType(r.rowIndex, e.target.value);
        await fetchRecipients();
      });

      const tdStatus = document.createElement('td'); tdStatus.className='p-2';
      tdStatus.innerHTML = selectHtml(STATUS_OPTIONS, r.status || '');
      const selStatus = tdStatus.querySelector('select');
      selStatus.addEventListener('change', async (e) => {
        selStatus.disabled = true;
        await updateStatus(r.rowIndex, e.target.value);
        await fetchRecipients();
      });

      const tdWA = document.createElement('td'); tdWA.className='p-2';
      if (r.waLink) {
        const a = document.createElement('a');
        a.className = 'btn px-3 py-1 rounded-md';
        a.textContent = 'Send';
        a.href = r.waLink;
        a.target = '_blank';
        a.addEventListener('click', async () => {
          const st = el('afterStatus').value || 'Whatsapp';
          try { await updateStatus(r.rowIndex, st); } catch (e) {}
        });
        tdWA.appendChild(a);
      } else {
        const span = document.createElement('span');
        span.className = 'muted text-xs';
        span.textContent = 'No link';
        tdWA.appendChild(span);
      }

      const tdName = document.createElement('td'); tdName.className='p-2'; tdName.textContent = r.name || '';
      const tdSur  = document.createElement('td'); tdSur.className='p-2'; tdSur.textContent  = r.surname || '';
      const tdNum  = document.createElement('td'); tdNum.className='p-2'; tdNum.textContent  = r.cell || '';
      const tdAg   = document.createElement('td'); tdAg.className='p-2'; tdAg.textContent   = r.agency || '';

      tr.appendChild(tdChk);
      tr.appendChild(tdType);
      tr.appendChild(tdStatus);
      tr.appendChild(tdWA);
      tr.appendChild(tdName);
      tr.appendChild(tdSur);
      tr.appendChild(tdNum);
      tr.appendChild(tdAg);

      tb.appendChild(tr);
    });

    const checkAll = document.getElementById('checkAll');
    checkAll.checked = (selected.size === rowsData.length && rowsData.length > 0);
    checkAll.onchange = (e) => {
      if (e.target.checked) {
        selected = new Set(rowsData.map((_, idx) => idx));
      } else {
        selected.clear();
      }
      renderTable();
      setSelCount();
    };
  }

  document.addEventListener('DOMContentLoaded', () => {
    el('btnApplyBulk').onclick = async () => {
      if (selected.size === 0) { alert('Select at least one row.'); return; }
      const newType = el('bulkType').value;
      const targets = Array.from(selected).map(i => rowsData[i].rowIndex);
      for (const ri of targets) {
        try { await updateMessageType(ri, newType); } catch(e) {}
      }
      await fetchRecipients();
    };
    el('btnClearSel').onclick = () => { selected.clear(); renderTable(); setSelCount(); };
    el('btnRefresh').onclick = fetchRecipients;
  });

  fetchRecipients();
</script>
</body>
</html>
