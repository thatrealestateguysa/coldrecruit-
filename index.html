<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Recruit 101</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--bg:#0a0a0a;--panel:#0f172a;--border:#1f2937;--text:#f8fafc;--muted:#e2e8f0;--chip:#334155;--chipText:#f1f5f9;--accent:#e11d48;}
html,body{background:var(--bg);color:var(--text)}
.card{background:var(--panel);border:1px solid var(--border)}
.badge{background:var(--chip);color:var(--chipText);border-radius:9999px;padding:2px 10px;font-size:.75rem}
.btn{background:var(--accent);color:#fff;border-radius:.5rem;padding:.5rem .8rem}
.input, .select{background:#0b1220;border:1px solid #64748b;border-radius:.5rem;padding:.5rem .6rem;color:#fff}
.table-head{background:rgba(255,255,255,.04);color:var(--muted)}
.tab{background:#334155;color:#f1f5f9;border:1px solid #475569;border-radius:9999px;padding:.5rem .85rem;white-space:nowrap}
.tab.active{background:#e11d48;border-color:#e11d48;color:#fff}
</style>
</head>
<body class="min-h-screen">
<div class="max-w-7xl mx-auto p-4 space-y-4">
<header class="flex items-center justify-between">
  <div><h1 class="text-xl font-semibold">Recruit 101</h1><div class="text-xs text-slate-300" id="env">v17c</div></div>
  <div class="flex items-center gap-2">
    <label class="text-sm">After-send status</label>
    <select id="after" class="select"></select>
    <button id="refresh" class="btn">Refresh</button>
  </div>
</header>

<section class="card rounded-xl p-4 space-y-3">
  <div class="flex items-center gap-3 flex-wrap">
    <span class="badge">Total <span id="total">0</span></span>
    <span class="badge">Filtered <span id="filtered">0</span></span>
  </div>
  <div id="tabs" class="flex gap-2 overflow-x-auto"></div>
  <div class="grid md:grid-cols-3 gap-2 items-end">
    <div class="md:col-span-2">
      <label class="text-sm">Search (Name or Agency)</label>
      <div class="flex gap-2">
        <input id="q" class="input w-full" placeholder="Type to filterâ€¦ (e.g. Ndlovu or 'Explore')"/>
        <button id="clear" class="badge">Clear</button>
      </div>
    </div>
    <div>
      <label class="text-sm">Status filter</label>
      <select id="f" class="select w-full"></select>
    </div>
  </div>
  <div id="err" class="text-xs text-rose-400"></div>
</section>

<section class="card rounded-xl p-3">
  <div class="overflow-auto">
    <table class="w-full text-sm">
      <thead class="table-head uppercase text-xs">
        <tr class="border-b border-slate-800">
          <th class="p-2 text-left">Message Type</th>
          <th class="p-2 text-left">Status</th>
          <th class="p-2 text-left">WhatsApp</th>
          <th class="p-2 text-left">Name</th>
          <th class="p-2 text-left">Surname</th>
          <th class="p-2 text-left">Number</th>
          <th class="p-2 text-left">Agency</th>
          <th class="p-2 text-left">Notes</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
  <div class="flex items-center justify-between mt-3">
    <div class="text-xs text-slate-300">Showing 15 per page</div>
    <div class="flex items-center gap-2">
      <button id="prev" class="badge">Prev</button>
      <span id="page" class="text-sm"></span>
      <button id="next" class="badge">Next</button>
    </div>
  </div>
</section>
</div>

<script>
const STATUS_OPTIONS=["To Contact","Whatsapp","Reply","Keen to meet","Cultivate","Invite to events","Not interested","No Whatsapp","Unsubscribe","Referred","Event Invite Sent","Event Invite Accepted"];
const DEFAULT_AFTER="Event Invite Sent"; const PAGE=15;
const EXEC="https://script.google.com/macros/s/AKfycbyvfBTI8TtRHb_6lnAvI5GEo90fJSQJ0HKRYKACgKoBrY4txHmpvlThSiBiicXjnJJq6g/exec"; const qs=new URLSearchParams(location.search); const GID=qs.get('gid')||"";

const $=id=>document.getElementById(id);
const E={env:$("env"),after:$("after"),refresh:$("refresh"),tabs:$("tabs"),q:$("q"),clear:$("clear"),f:$("f"),err:$("err"),
rows:$("rows"),total:$("total"),filtered:$("filtered"),prev:$("prev"),next:$("next"),page:$("page")};

let all=[], view=[], page=1, counts={};

function api(action, params={}){ const u=new URL(EXEC); if(action)u.searchParams.set("action",action); if(GID)u.searchParams.set("gid",GID); for(const[k,v] of Object.entries(params))u.searchParams.set(k,v); u.searchParams.set("t",Date.now()); return fetch(u).then(r=>r.json()); }
function post(payload){ const u=new URL(EXEC); if(GID)u.searchParams.set('gid',GID); return fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}).then(r=>r.json()); }
function opt(v,s){return `<option value="${v}"${s?" selected":""}>${v}</option>`}
function renderTabs(){ const sel=E.f.value||""; const tabs=[{k:"",l:"All",c:Object.values(counts).reduce((a,b)=>a+b,0)}]; STATUS_OPTIONS.forEach(s=>tabs.push({k:s,l:s,c:(counts[s]||0)}));
  E.tabs.innerHTML=tabs.map(t=>`<button class="tab${t.k===sel?" active":""}" data-k="${t.k}">${t.l} <span class="badge">${t.c}</span></button>`).join("");
  [...E.tabs.querySelectorAll(".tab")].forEach(b=>b.onclick=()=>{E.f.value=b.dataset.k; load();});
}

async function stats(){ try{ const s=await api("stats"); counts=s.byStatus||{}; E.total.textContent=s.total||0; }catch(e){ counts={}; all.forEach(r=>counts[r.status]=(counts[r.status]||0)+1); E.total.textContent=all.length; } renderTabs(); }

async function load(){ const status=(E.f.value||"").trim(); const js=await api("recipients", status?{status}:{}); all=js.recipients||[]; await stats(); apply(); }
function apply(){ const q=(E.q.value||"").toLowerCase().trim(); view=all.filter(r=>!q||String(r.name||"").toLowerCase().includes(q)||String(r.surname||"").toLowerCase().includes(q)||String(r.agency||"").toLowerCase().includes(q)); E.filtered.textContent=view.length; page=1; draw(); }
function pageSlice(){ const s=(page-1)*PAGE; return view.slice(s,s+PAGE); }
function setPage(){ const max=Math.max(1,Math.ceil(view.length/PAGE)); if(page<1)page=1; if(page>max)page=max; E.page.textContent=`Page ${page} of ${max}`; E.prev.disabled=page<=1; E.next.disabled=page>=max; }

function rowId(r){return r.rowNumber || (r.rowIndex? (r.rowIndex+2) : null);}

async function changeStatus(r,newStatus,control){ if(!rowId(r)) return; control && (control.disabled=true);
  try{ const res=await post({action:"updateSingleStatus",payload:{rowNumber:rowId(r),newStatus}}); await load(); }
  catch(e){ console.error(e); }
  finally{ control && (control.disabled=false); }
}

function draw(){ E.rows.innerHTML=""; const rows=pageSlice(); if(!rows.length){E.rows.innerHTML='<tr><td class="p-3 text-slate-300" colspan="8">No rows.</td></tr>'; setPage(); return;}
  rows.forEach(r=>{ const tr=document.createElement("tr"); tr.className="border-b border-slate-800"; tr.dataset.row=rowId(r);
    const type=document.createElement("td"); type.className="p-2"; type.innerHTML=`<span class="badge">${r.messageType||"Recruit"}</span>`;
    const st=document.createElement("td"); st.className="p-2"; st.innerHTML=`<select class="select">${STATUS_OPTIONS.map(s=>`<option value="${s}"${s===(r.status||"")?" selected":""}>${s}</option>`).join("")}</select>`;
    const sel=st.querySelector("select"); sel.onchange=()=>changeStatus(r,sel.value,sel);
    const wa=document.createElement("td"); wa.className="p-2"; const btn=document.createElement("button"); btn.className="btn"; btn.textContent="Send";
      const link=r.waLink||""; const ok=/^https:\/\/(api\.whatsapp\.com|web\.whatsapp\.com|wa\.me)\//.test(link);
      if(!ok) btn.disabled=true;
      btn.onclick=async()=>{ let phone="",text=""; try{const u=new URL(link); phone=(u.searchParams.get("phone")||"").replace(/\D/g,""); text=u.searchParams.get("text")||"";}catch(_){}
        if(!phone){const m=link.match(/wa\.me\/(\d+)/); if(m) phone=m[1];}
        if(!phone) return;
        const txt=encodeURIComponent(text);
        try{window.location.href=`whatsapp://send?phone=${phone}&text=${txt}`; setTimeout(()=>{ if(!document.hidden) window.open(`https://web.whatsapp.com/send?phone=${phone}&text=${txt}`,"_blank","noopener"); },900);}
        catch(_){ try{ window.open(`https://web.whatsapp.com/send?phone=${phone}&text=${txt}`,"_blank","noopener"); }catch(__){} }
        await changeStatus(r, ($("after").value||DEFAULT_AFTER), btn);
      };
      wa.appendChild(btn);
    const name=document.createElement("td"); name.className="p-2"; name.textContent=r.name||"";
    const sur=document.createElement("td"); sur.className="p-2"; sur.textContent=r.surname||"";
    const num=document.createElement("td"); num.className="p-2"; num.textContent=r.cell||"";
    const ag=document.createElement("td"); ag.className="p-2"; ag.textContent=r.agency||"";
    const notes=document.createElement("td"); notes.className="p-2"; const nb=document.createElement("button"); nb.className="badge"; nb.textContent="Edit";
      nb.onclick=async()=>{ const v=prompt("Edit note for "+(r.name||""), r.notes||""); if(v===null) return; nb.disabled=true; try{ await post({action:"updateNote",payload:{rowNumber:rowId(r),note:v}}); await load(); } finally{ nb.disabled=false; } }
      notes.appendChild(nb);
    tr.append(type,st,wa,name,sur,num,ag,notes); E.rows.appendChild(tr);
  });
  setPage();
}

document.addEventListener("DOMContentLoaded", async()=>{ E.after.innerHTML=STATUS_OPTIONS.map(s=>opt(s,s===DEFAULT_AFTER)).join(""); E.f.innerHTML='<option value="">(All)</option>'+STATUS_OPTIONS.map(s=>opt(s,false)).join(""); 
  E.q.oninput=()=>apply(); E.clear.onclick=()=>{E.q.value=""; apply();}; E.f.onchange=()=>load(); E.prev.onclick=()=>{page--; draw();}; E.next.onclick=()=>{page++; draw();}; E.refresh.onclick=()=>load();
  try{ await load(); }catch(e){ E.err.textContent=(e.message||e); }
});
</script>
</body></html>
