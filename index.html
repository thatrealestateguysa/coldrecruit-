<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cold Recruit Machine — WhatsApp Sender</title>
  <link rel="icon" href="./assets/icon.png">
  <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#111827">
  <style>
    html, body { background:#0b0b0b; color:#e5e7eb; }
    .card { background:#1f2937; }
    .muted { color:#9ca3af; }
    .btn { background:#e11d48; }
    .btn:hover { opacity:.95 }
    .chip { background:#111827; }
    code { background:#111827; padding:2px 6px; border-radius:6px; }
    select, textarea, input { background:#0b0b0b; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-7xl mx-auto p-4">
    <header class="mb-6 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="./assets/logo.png" alt="logo" class="h-10 w-auto rounded-lg" />
        <h1 class="text-2xl font-semibold">Cold Recruit Machine — WhatsApp Sender</h1>
      </div>
      <div class="flex gap-2">
        <button id="btnReload" class="px-3 py-2 rounded-lg card">Reload</button>
        <button id="btnSettings" class="px-3 py-2 rounded-lg card">Settings</button>
      </div>
    </header>

    <!-- Filters -->
    <section class="mb-4 grid md:grid-cols-4 gap-3">
      <div class="card rounded-xl p-3">
        <label class="text-sm">Filter by Agency</label>
        <select id="agencyFilter" multiple class="w-full rounded-lg p-2 h-28 card"></select>
        <p class="text-xs muted mt-1">Hold Ctrl/Cmd to multi-select.</p>
      </div>
      <div class="card rounded-xl p-3">
        <label class="text-sm">Search name or number</label>
        <input id="searchBox" class="w-full rounded-lg p-2 card" placeholder="Type to filter..." />
      </div>
      <div class="card rounded-xl p-3">
        <label class="text-sm">Message Type (UI)</label>
        <select id="uiTemplate" class="w-full rounded-lg p-2">
          <option value="perrow">Use per-row MESSAGE TYPE</option>
          <option value="recruit">Recruit</option>
          <option value="event1">Event 1 — Win Win</option>
        </select>
        <p class="text-xs muted mt-1">Choose a template to prefill Quick Text, or use each row's MESSAGE TYPE column.</p>
      </div>
      <div class="flex items-end gap-2">
        <button id="btnSelectAll" class="px-3 py-2 rounded-lg card">Select All (filtered)</button>
        <button id="btnClearSel" class="px-3 py-2 rounded-lg card">Clear</button>
      </div>
    </section>

    <!-- Table -->
    <section class="card rounded-xl p-3">
      <div class="overflow-auto">
        <table class="w-full text-sm">
          <thead class="muted">
            <tr class="border-b border-neutral-700">
              <th class="p-2"><input type="checkbox" id="checkAll"/></th>
              <th class="p-2">Status</th>
              <th class="p-2">Message Type</th>
              <th class="p-2">Name</th>
              <th class="p-2">Surname</th>
              <th class="p-2">Cell Nr</th>
              <th class="p-2">Agency</th>
              <th class="p-2">Notes</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <!-- Composer -->
    <section class="mt-6 grid lg:grid-cols-2 gap-4">
      <!-- Images -->
      <div class="card rounded-xl p-4">
        <h2 class="font-semibold mb-2">Send Image + Caption</h2>
        <div class="mb-3">
          <label class="text-sm block mb-1">Caption (supports {'{name}'} {'{surname}'} {'{agency}'} {'{full_name}'})</label>
          <textarea id="caption" rows="3" class="w-full rounded-lg p-2" placeholder="Add a caption..."></textarea>
        </div>
        <div class="mb-3">
          <label class="text-sm block mb-1">Image</label>
          <input id="imageFile" type="file" accept="image/*" class="block w-full text-sm" />
          <img id="preview" class="mt-2 max-h-40 rounded-lg hidden" />
        </div>
        <div class="flex items-center gap-4 mb-3">
          <label class="inline-flex items-center gap-2">
            <input id="useCloudApiImg" type="radio" name="modeImg" checked>
            <span>Send with Cloud API (image supported)</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input id="useDeviceImg" type="radio" name="modeImg">
            <span>Open on my device (text only)</span>
          </label>
        </div>
        <div class="flex gap-3">
          <button id="btnSendImage" class="px-4 py-2 btn rounded-xl">Send Image to Selected</button>
          <span id="statusImg" class="text-sm muted"></span>
        </div>
      </div>

      <!-- Quick Text -->
      <div class="card rounded-xl p-4">
        <h2 class="font-semibold mb-2">Quick Text</h2>
        <div class="mb-3">
          <label class="text-sm block mb-1">Message template</label>
          <textarea id="quickText" rows="6" class="w-full rounded-lg p-2"
            placeholder="Your message...">{{name}}, are you ready to close deals where everyone wins? Dawie, your Team Leader, is inviting you to an exclusive FREE Win-Win Negotiations Workshop at KW Explore on Nov 6. It's a full day of skills training (lunch included!) to elevate your game. Register here before it fills up: https://explore.yourkwoffice.com/winwin-negotiations</textarea>
          <p class="text-xs muted mt-1">Placeholders: <code>{'{name}'}</code> <code>{'{surname}'}</code> <code>{'{agency}'}</code> <code>{'{full_name}'}</code></p>
        </div>
        <div class="flex items-center gap-4 mb-3">
          <label class="inline-flex items-center gap-2">
            <input id="useCloudApiText" type="radio" name="modeText" checked>
            <span>Send with Cloud API</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input id="useDeviceText" type="radio" name="modeText">
            <span>Open device links (wa.me)</span>
          </label>
        </div>
        <div class="flex gap-3">
          <button id="btnSendText" class="px-4 py-2 btn rounded-xl">Send Text to Selected</button>
          <span id="statusText" class="text-sm muted"></span>
        </div>
      </div>
    </section>

    <!-- Queue -->
    <section class="mt-6 card rounded-xl p-4">
      <h2 class="font-semibold mb-2">Queue</h2>
      <div id="queue" class="text-sm space-y-1 max-h-72 overflow-auto"></div>
    </section>
  </div>

  <!-- Settings -->
  <dialog id="settingsDlg" class="rounded-xl p-4 card w-[32rem]">
    <h3 class="font-semibold text-lg mb-3">Settings</h3>
    <label class="block text-sm mb-1">Override Web App URL</label>
    <input id="webAppUrl" class="w-full rounded-lg p-2 mb-4" placeholder="leave blank to use wired URL">
    <div class="flex justify-end gap-2">
      <button id="btnSaveSecrets" class="px-3 py-2 btn rounded-lg">Save URL</button>
      <button id="btnCloseSettings" class="px-3 py-2 rounded-lg" style="background:#374151">Close</button>
    </div>
    <p class="text-xs muted mt-2">Note: Cloud API credentials are set in the backend (action=setsecrets).</p>
  </dialog>

  <script>
    const WIRED_URL = "https://script.google.com/macros/s/AKfycbwgadpWje7SvdQU1JaWnE9QNKN_7KUHYclDU6ww_0RLtDd06MTLj6voudYdV3IGikqTDg/exec";
    let WEB_APP_URL = localStorage.getItem('crm_webapp') || WIRED_URL;

    const EVENT_WINWIN = `{{name}}, are you ready to close deals where everyone wins? Dawie, your Team Leader, is inviting you to an exclusive FREE Win-Win Negotiations Workshop at KW Explore on Nov 6. It's a full day of skills training (lunch included!) to elevate your game. Register here before it fills up: https://explore.yourkwoffice.com/winwin-negotiations`;
    const RECRUIT_DEFAULT = `Hi {{name}}, Dawie here from KW Explore. I’m connecting with a few agents to compare what’s working and to share how we structure costs, coaching and lead gen so more of your commission stays with you. No pitch, just a short, numbers based business conversation to see if it’s useful. If you’re open, reply YES and we’ll take it from there. If not, reply STOP and I won’t follow up.

Dawie
Team Leader at KW Explore
https://thatrealestateguysa.kw.com/`;

    const state = { recipients: [], filtered: [], selected: new Set() };
    const el = id => document.getElementById(id);
    const fmtName = r => [r.name, r.surname].filter(Boolean).join(' ');

    function personalize(text, r) {
      return (text || '')
        .replace(/\{\{name\}\}/g, r.name || '')
        .replace(/\{\{surname\}\}/g, r.surname || '')
        .replace(/\{\{agency\}\}/g, r.agency || '')
        .replace(/\{\{full_name\}\}/g, [r.name, r.surname].filter(Boolean).join(' '));
    }

    async function loadAll() {
      const url = new URL(WEB_APP_URL);
      url.searchParams.set('action', 'recipients');
      const res = await fetch(url.toString());
      const js = await res.json();
      state.recipients = js.recipients || [];
      await buildAgencies();
      applyFilter();
    }
    async function buildAgencies() {
      const url = new URL(WEB_APP_URL);
      url.searchParams.set('action', 'agencies');
      const res = await fetch(url.toString());
      const { agencies } = await res.json();
      const sel = el('agencyFilter');
      sel.innerHTML = '';
      (agencies || []).forEach(a => {
        const opt = document.createElement('option');
        opt.value = a; opt.textContent = a;
        sel.appendChild(opt);
      });
    }

    function applyFilter() {
      const sel = Array.from(el('agencyFilter').selectedOptions).map(o=>o.value);
      const q = (el('searchBox').value || '').trim().toLowerCase();
      state.filtered = state.recipients.filter(r => {
        const okAgency = sel.length ? sel.includes(r.agency) : true;
        const inText = (fmtName(r)+' '+(r.cell||'')+' '+(r.agency||'')).toLowerCase().includes(q);
        return okAgency && inText;
      });
      renderRows();
    }

    function renderRows() {
      const tb = el('rows'); tb.innerHTML = '';
      state.filtered.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-neutral-700';
        tr.innerHTML = `
          <td class="p-2"><input type="checkbox" data-id="${idx}" ${state.selected.has(idx)?'checked':''}></td>
          <td class="p-2">${r.status || ''}</td>
          <td class="p-2">${r.messageType || ''}</td>
          <td class="p-2">${r.name || ''}</td>
          <td class="p-2">${r.surname || ''}</td>
          <td class="p-2">${r.cell || ''}</td>
          <td class="p-2">${r.agency || ''}</td>
          <td class="p-2">${r.notes || ''}</td>
        `;
        tb.appendChild(tr);
      });
    }

    function readImageAsBase64(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    function getSelectedRecipients() {
      const indices = Array.from(state.selected);
      return indices.map(i => {
        const r = state.filtered[i];
        return {
          name: r.name, surname: r.surname, agency: r.agency, phone: r.cell,
          messageType: r.messageType, status: r.status, notes: r.notes
        };
      });
    }

    async function sendImages() {
      const recipients = getSelectedRecipients();
      if (recipients.length === 0) return alert('Select at least one contact.');
      const caption = el('caption').value || '';
      const useCloud = el('useCloudApiImg').checked;

      if (useCloud) {
        const file = el('imageFile').files[0];
        if (!file) return alert('Choose an image.');
        const base64 = await readImageAsBase64(file);
        el('statusImg').textContent = 'Sending...';
        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'bulksendimage',
            useCloudApi: true,
            recipients,
            caption,
            imageBase64: base64,
            imageMime: file.type
          })
        });
        const json = await res.json();
        renderQueue(json.results || []);
        el('statusImg').textContent = json.ok ? 'Done' : (json.error || 'Error');
      } else {
        recipients.forEach(r => {
          const to = (r.phone || '').replace(/[^\d+]/g,'').replace(/^\+/, '');
          const url = `https://wa.me/${to}?text=${encodeURIComponent(personalize(caption, r))}`;
          window.open(url, '_blank');
        });
        el('statusImg').textContent = 'Opened device links. Attach the image manually.';
      }
    }

    async function sendTexts() {
      const recipients = getSelectedRecipients();
      if (recipients.length === 0) return alert('Select at least one contact.');
      const useCloud = el('useCloudApiText').checked;
      const mode = el('uiTemplate').value;
      el('statusText').textContent = 'Sending...';

      if (mode === 'perrow') {
        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'bulksendtextbytype',
            useCloudApi: useCloud,
            recipients
          })
        });
        const json = await res.json();
        renderQueue(json.results || []);
        el('statusText').textContent = json.ok ? 'Done' : (json.error || 'Error');
      } else {
        let tmpl = el('quickText').value || '';
        if (mode === 'recruit') tmpl = RECRUIT_DEFAULT;
        if (mode === 'event1') tmpl = EVENT_WINWIN;
        if (useCloud) {
          const res = await fetch(WEB_APP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'bulksendtext',
              useCloudApi: true,
              textTemplate: tmpl,
              recipients
            })
          });
          const json = await res.json();
          renderQueue(json.results || []);
          el('statusText').textContent = json.ok ? 'Done' : (json.error || 'Error');
        } else {
          const results = [];
          for (const r of recipients) {
            const to = (r.phone || '').replace(/[^\d+]/g,'').replace(/^\+/, '');
            const url = `https://wa.me/${to}?text=${encodeURIComponent(personalize(tmpl, r))}`;
            window.open(url, '_blank');
            results.push({ phone: '+'+to, status:'LINK_TEXT', link:url });
          }
          renderQueue(results);
          el('statusText').textContent = 'Device links opened.';
        }
      }
    }

    function renderQueue(results) {
      const box = el('queue'); box.innerHTML = '';
      (results || []).forEach(r => {
        const div = document.createElement('div');
        div.className = 'p-2 rounded-lg chip';
        div.textContent = `${r.phone} — ${r.status}${r.messageId ? ' ('+r.messageId+')' : ''}${r.link ? ' — link opened' : ''}${r.error ? ' — '+r.error : ''}`;
        box.appendChild(div);
      });
    }

    // UI events
    const elTpl = el('uiTemplate');
    elTpl.onchange = () => {
      const v = elTpl.value;
      if (v === 'recruit') el('quickText').value = RECRUIT_DEFAULT;
      else if (v === 'event1') el('quickText').value = EVENT_WINWIN;
      // 'perrow' keeps whatever is typed; backend will ignore this field.
    };

    el('btnSettings').onclick = () => el('settingsDlg').showModal();
    el('btnCloseSettings').onclick = () => el('settingsDlg').close();
    el('btnSaveSecrets').onclick = () => {
      const u = el('webAppUrl').value.trim();
      if (u) { WEB_APP_URL = u; localStorage.setItem('crm_webapp', u); alert('Saved. Reload to apply.'); }
      else { WEB_APP_URL = WIRED_URL; localStorage.removeItem('crm_webapp'); alert('Using wired URL.'); }
    };
    el('btnReload').onclick = loadAll;
    el('btnSelectAll').onclick = () => { state.selected = new Set(state.filtered.map((_,i)=>i)); renderRows(); };
    el('btnClearSel').onclick = () => { state.selected.clear(); renderRows(); };
    el('checkAll').onchange = (e) => { if (e.target.checked) state.selected = new Set(state.filtered.map((_,i)=>i)); else state.selected.clear(); renderRows(); };
    el('rows').addEventListener('change', (e) => {
      const idx = Number(e.target.dataset.id);
      if (!Number.isNaN(idx)) { if (e.target.checked) state.selected.add(idx); else state.selected.delete(idx); }
    });
    el('agencyFilter').onchange = applyFilter;
    el('searchBox').oninput = applyFilter;
    el('imageFile').onchange = () => {
      const f = el('imageFile').files[0];
      if (!f) return el('preview').classList.add('hidden');
      el('preview').src = URL.createObjectURL(f);
      el('preview').classList.remove('hidden');
    };
    el('btnSendImage').onclick = sendImages;
    el('btnSendText').onclick = sendTexts;

    loadAll();
  </script>
</body>
</html>
