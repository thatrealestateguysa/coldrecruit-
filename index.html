<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recruit 101</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0b0b0b">
  <link rel="icon" href="./assets/icon.png">
  <style>
    html,body { background:#0b0b0b; color:#e5e7eb; }
    .card { background:#111827; border:1px solid #1f2937; }
    select, input { background:#0b0b0b; border:1px solid #374151; }
    a.btn, button.btn { background:#e11d48; color:white; }
    .muted { color:#9ca3af; }
    .chip { background:#1f2937; border:1px solid #374151; padding:6px 10px; border-radius:9999px; cursor:pointer; }
    .chip.active { background:#e11d48; color:white; border-color:#e11d48; }
    .btn-lite { background:#374151; color:#e5e7eb; }
    .badge { background:#374151; color:#e5e7eb; padding:2px 8px; border-radius:9999px; font-size:12px; }
    table th, table td { white-space: nowrap; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-7xl mx-auto p-4 space-y-4">

    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="./assets/logo.png" alt="Recruit 101" class="h-10 w-auto rounded-md" />
        <h1 class="text-xl font-semibold">Recruit 101</h1>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm">After-send status</label>
        <select id="afterStatus" class="rounded-md p-2"></select>
        <button id="btnRefresh" class="btn px-3 py-2 rounded-md">Refresh</button>
      </div>
    </header>

    <!-- Status bar + filters -->
    <section class="card rounded-xl p-3 space-y-3">
      <div id="statusBar" class="flex gap-2 overflow-x-auto pb-1"></div>
      <div class="grid md:grid-cols-4 gap-2 items-end">
        <div>
          <label class="text-sm block mb-1">Search Name</label>
          <input id="fName" class="rounded-md p-2 w-full" placeholder="e.g. Thabo / de Villiers" />
        </div>
        <div>
          <label class="text-sm block mb-1">Search Agency</label>
          <input id="fAgency" class="rounded-md p-2 w-full" placeholder="e.g. KW Explore" />
        </div>
        <div>
          <label class="text-sm block mb-1">Filter by Status</label>
          <select id="fStatus" class="rounded-md p-2 w-full"></select>
        </div>
        <div class="flex gap-2">
          <button id="btnApplyFilters" class="btn-lite px-3 py-2 rounded-md">Apply Filters</button>
          <button id="btnClearFilters" class="btn-lite px-3 py-2 rounded-md">Clear</button>
        </div>
      </div>
      <div class="text-xs muted">
        <span id="resultCount">0</span> matching of <span id="totalCount">0</span> total
      </div>
    </section>

    <!-- Table -->
    <section class="card rounded-xl p-3">
      <div class="overflow-auto">
        <table class="w-full text-sm">
          <thead class="text-xs uppercase muted">
            <tr class="border-b border-neutral-800">
              <th class="p-2 text-left">Message Type</th>
              <th class="p-2 text-left">Status</th>
              <th class="p-2 text-left">WhatsApp</th>
              <th class="p-2 text-left">Name</th>
              <th class="p-2 text-left">Surname</th>
              <th class="p-2 text-left">Number</th>
              <th class="p-2 text-left">Agency</th>
              <th class="p-2 text-left">Notes</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex items-center justify-between mt-3">
        <div class="text-xs muted">Showing 15 per page</div>
        <div class="flex items-center gap-2">
          <button id="prevPage" class="btn-lite px-3 py-2 rounded-md">Prev</button>
          <span id="pageInfo" class="text-sm"></span>
          <button id="nextPage" class="btn-lite px-3 py-2 rounded-md">Next</button>
        </div>
      </div>
    </section>
  </div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxPApgm_UeIU8rYA0TmqpSypOEUnLjSY86othzkrSBFvYcnNkjz54vgxhXcvotfuFoSCw/exec";
  const STATUS_OPTIONS = ["To Contact", "Whatsapp", "Reply", "Keen to meet", "Cultivate", "Invite to events", "Not interested", "No Whatsapp", "Unsubscribe", "Referred", "Event Invite Sent", "Event Invite Accepted"];
  const DEFAULT_AFTER_SEND = "Event Invite Sent";

  // Forward gid from the page URL (example: index.html?gid=123456789)
  const GID = new URLSearchParams(location.search).get('gid');

  const PAGE_SIZE = 15;
  let currentPage = 1;
  let rowsData = [];     // dataset from backend (already filtered server-side)
  let totalCount = 0;    // total available (from stats)

  // Elements
  const el = (id) => document.getElementById(id);
  const E = {
    afterStatus: el('afterStatus'),
    btnRefresh: el('btnRefresh'),
    statusBar: el('statusBar'),
    fName: el('fName'),
    fAgency: el('fAgency'),
    fStatus: el('fStatus'),
    btnApplyFilters: el('btnApplyFilters'),
    btnClearFilters: el('btnClearFilters'),
    resultCount: el('resultCount'),
    totalCount: el('totalCount'),
    rows: el('rows'),
    pageInfo: el('pageInfo'),
    prevPage: el('prevPage'),
    nextPage: el('nextPage')
  };

  function optHtml(v, sel){ return '<option value="'+v.replaceAll('"','&quot;')+'" '+(sel?'selected':'')+'>'+v+'</option>'; }

  // Initialize dropdowns
  function initControls(){
    // after-send status
    E.afterStatus.innerHTML = STATUS_OPTIONS.map(s => optHtml(s, s===DEFAULT_AFTER_SEND)).join('');
    // filter status (with blank for all)
    E.fStatus.innerHTML = '<option value="">(All)</option>' + STATUS_OPTIONS.map(s => optHtml(s, false)).join('');
  }

  // Helpers
  function buildUrl(action){
    const url = new URL(WEB_APP_URL);
    url.searchParams.set('action', action);
    if (GID) url.searchParams.set('gid', GID);
    return url;
  }
  function pageSlice(){
    const start = (currentPage - 1) * PAGE_SIZE;
    return rowsData.slice(start, start + PAGE_SIZE);
  }
  function updatePagerUI(){
    const totalPages = Math.max(1, Math.ceil(rowsData.length / PAGE_SIZE));
    if (currentPage < 1) currentPage = 1;
    if (currentPage > totalPages) currentPage = totalPages;
    E.pageInfo.textContent = 'Page ' + currentPage + ' of ' + totalPages;
    E.prevPage.disabled = (currentPage <= 1);
    E.nextPage.disabled = (currentPage >= totalPages);
  }

  // Stats bar
  async function fetchStats(){
    const url = buildUrl('stats'); url.searchParams.set('t', Date.now());
    const res = await fetch(url.toString()); const js = await res.json();
    renderStatusBar(js.byStatus || {});
    totalCount = js.total || 0;
    E.totalCount.textContent = totalCount;
  }
  function renderStatusBar(byStatus){
    // Order by our STATUS_OPTIONS; include "Other" aggregated for non-list keys
    const chips = [];
    const seen = new Set();
    chips.push({label:'All', key:'', count:Object.values(byStatus).reduce((a,b)=>a+b,0)});
    STATUS_OPTIONS.forEach(s => { chips.push({label:s, key:s, count:(byStatus[s]||0)}); seen.add(s); });
    const others = Object.keys(byStatus).filter(k => !seen.has(k));
    if (others.length){
      const c = others.map(k => byStatus[k]||0).reduce((a,b)=>a+b,0);
      chips.push({label:'Other', key:'__other__', count:c});
    }

    const selectedKey = E.fStatus.value || '';
    E.statusBar.innerHTML = chips.map(ch => {
      const active = (selectedKey === ch.key || (selectedKey==='' && ch.key===''));
      return '<span class="chip '+(active?'active':'')+'" data-key="'+ch.key.replaceAll('"','&quot;')+'">'+ch.label+': '+ch.count+'</span>';
    }).join('');

    Array.from(E.statusBar.querySelectorAll('.chip')).forEach(ch => {
      ch.addEventListener('click', () => {
        const key = ch.getAttribute('data-key');
        if (key === '__other__') {
          // Selecting "Other" in the bar sets status filter to blank; user can refine via dropdown
          E.fStatus.value = '';
        } else {
          E.fStatus.value = key;
        }
        applyFilters();
      });
    });
  }

  // Data
  async function fetchRecipients(){
    const url = buildUrl('recipients');
    url.searchParams.set('t', Date.now());
    const name = (E.fName.value || '').trim();
    const agency = (E.fAgency.value || '').trim();
    const status = (E.fStatus.value || '').trim();
    if (name) url.searchParams.set('name', name);
    if (agency) url.searchParams.set('agency', agency);
    if (status) url.searchParams.set('status', status);
    const res = await fetch(url.toString());
    const js = await res.json();
    rowsData = js.recipients || [];
    E.resultCount.textContent = rowsData.length;
    currentPage = 1;
    renderTable();
    updatePagerUI();
  }

  async function postAction(action, payload){
    const url = buildUrl('');
    const res = await fetch(url.toString(), {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action, payload })
    });
    const js = await res.json();
    if (js && js.result === 'error') throw new Error(js.message||'Server error');
    return js || { result:'ok' };
  }

  async function updateStatus(rowIndex, newStatus){
    return postAction('updateSingleStatus', { rowIndex, newStatus });
  }
  async function updateNote(rowIndex, note){
    return postAction('updateNote', { rowIndex, note });
  }

  // Render rows
  function selectHtml(opts, current) {
    let html = '<select class="rounded-md p-1">';
    for (const o of opts) {
      const sel = (o === current) ? 'selected' : '';
      html += '<option value="'+o.replaceAll('"','&quot;')+'" '+sel+'>'+o+'</option>';
    }
    html += '</select>';
    return html;
  }

  function renderTable(){
    E.rows.innerHTML = '';
    const slice = pageSlice();
    slice.forEach(r => {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-neutral-800';

      // Message Type (read-only)
      const tdType = document.createElement('td'); tdType.className='p-2';
      tdType.innerHTML = '<span class="badge">'+(r.messageType || 'Recruit')+'</span>';

      // Status (editable)
      const tdStatus = document.createElement('td'); tdStatus.className='p-2';
      tdStatus.innerHTML = selectHtml(STATUS_OPTIONS, r.status || '');
      const selStatus = tdStatus.querySelector('select');
      selStatus.addEventListener('change', async (e) => {
        selStatus.disabled = true;
        try { await updateStatus(r.rowIndex, e.target.value); } catch(e){ console.error(e); }
        await fetchStats();
        await fetchRecipients();
      });

      // WhatsApp button
      const tdWA = document.createElement('td'); tdWA.className='p-2';
      if (r.waLink) {
        const a = document.createElement('a');
        a.className = 'btn px-3 py-1 rounded-md';
        a.textContent = 'Send';
        a.href = r.waLink; a.target = '_blank';
        a.addEventListener('click', async () => {
          const stSel = E.afterStatus;
          const st = stSel ? stSel.value : DEFAULT_AFTER_SEND;
          try { await updateStatus(r.rowIndex, st); } catch (e) {}
          await fetchStats();
          await fetchRecipients();
        });
        tdWA.appendChild(a);
      } else {
        const m = document.createElement('span'); m.className='muted text-xs'; m.textContent='No link';
        tdWA.appendChild(m);
      }

      // Name, Surname, Number, Agency
      const tdName = document.createElement('td'); tdName.className='p-2'; tdName.textContent = r.name || '';
      const tdSur  = document.createElement('td'); tdSur.className='p-2'; tdSur.textContent  = r.surname || '';
      const tdNum  = document.createElement('td'); tdNum.className='p-2'; tdNum.textContent  = r.cell || '';
      const tdAg   = document.createElement('td'); tdAg.className='p-2'; tdAg.textContent   = r.agency || '';

      // Notes
      const tdNote = document.createElement('td'); tdNote.className='p-2';
      const btnN = document.createElement('button'); btnN.className='btn-lite px-2 py-1 rounded-md'; btnN.textContent='Edit';
      btnN.addEventListener('click', async () => {
        const newNote = prompt('Edit note for '+(r.name||''), r.notes || '');
        if (newNote === null) return; // cancelled
        btnN.disabled = true;
        try { await updateNote(r.rowIndex, newNote); } catch (e) { console.error(e); }
        await fetchRecipients();
      });
      tdNote.appendChild(btnN);

      tr.appendChild(tdType);
      tr.appendChild(tdStatus);
      tr.appendChild(tdWA);
      tr.appendChild(tdName);
      tr.appendChild(tdSur);
      tr.appendChild(tdNum);
      tr.appendChild(tdAg);
      tr.appendChild(tdNote);

      E.rows.appendChild(tr);
    });
  }

  // Filters
  async function applyFilters(){
    await fetchRecipients();
  }
  function clearFilters(){
    E.fName.value = '';
    E.fAgency.value = '';
    E.fStatus.value = '';
  }

  // Wire events
  document.addEventListener('DOMContentLoaded', async () => {
    initControls();
    E.btnApplyFilters.addEventListener('click', applyFilters);
    E.btnClearFilters.addEventListener('click', async () => { clearFilters(); await applyFilters(); });
    E.btnRefresh.addEventListener('click', async () => { await fetchStats(); await applyFilters(); });
    E.prevPage.addEventListener('click', () => { currentPage--; renderTable(); updatePagerUI(); });
    E.nextPage.addEventListener('click', () => { currentPage++; renderTable(); updatePagerUI(); });

    await fetchStats();
    await applyFilters();
  });
</script>
</body>
</html>
