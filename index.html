<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Recruit 101</title>
<link rel="icon" href="./assets/icon.png"><link rel="manifest" href="./manifest.webmanifest">
<script>if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('./service-worker.js').catch(()=>{}));}</script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{ --bg:#0b0c10;--panel:#0f172a;--panel2:#0b1220;--border:#1f2937;--text:#f8fafc;--muted:#e2e8f0;--chip:#334155;--chipText:#f1f5f9;--accent:#e11d48;}
html,body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.card{background:var(--panel);border:1px solid var(--border)}
.badge{background:var(--chip);color:var(--chipText);border-radius:9999px;padding:6px 10px;font-size:.75rem}
.btn{background:var(--accent);color:#fff;border-radius:.6rem;padding:.55rem .9rem}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-ghost{background:#1f2937;color:#e2e8f0;border:1px solid #334155;border-radius:.6rem;padding:.5rem .8rem}
.input,.select{background:var(--panel2);border:1px solid #64748b;border-radius:.6rem;padding:.6rem .7rem;color:#fff}
.table-head{background:rgba(255,255,255,.04);color:var(--muted)}
.sticky-head{position:sticky;top:0;background:var(--panel);z-index:10}
.logo{height:40px;filter:drop-shadow(0 0 2px rgba(0,0,0,.35));}
</style>
</head>
<body class="min-h-screen">
<div class="max-w-7xl mx-auto p-4 space-y-4">
  <header class="flex items-center justify-between gap-3 flex-wrap">
    <div class="flex items-center gap-3">
      <img src="./assets/kw-explore.png" alt="KW Explore" class="logo"/>
      <div><h1 class="text-xl font-semibold">Recruit 101</h1><div class="text-xs text-slate-300" id="env">v21.6 — new window every send</div></div>
    </div>
    <div class="flex items-center gap-3">
      <span id="apiBadge" class="badge hidden"></span>
      <button id="refresh" class="btn">Refresh</button>
    </div>
  </header>

  <section class="card rounded-xl p-4 space-y-4">
    <div class="flex items-center gap-3 flex-wrap">
      <span class="badge">Total <span id="total">0</span></span>
      <span class="badge">Filtered <span id="filtered">0</span></span>
    </div>

    <div class="grid md:grid-cols-3 gap-2 items-end">
      <div class="md:col-span-2">
        <label class="text-sm">Search (Name or Agency)</label>
        <div class="flex gap-2">
          <input id="q" class="input w-full" placeholder="Type to filter… (e.g. Ndlovu or 'Explore')" />
          <button id="clear" class="badge">Clear</button>
        </div>
      </div>
      <div>
        <label class="text-sm">Status</label>
        <select id="f" class="select w-full"></select>
      </div>
    </div>
    <div id="err" class="text-xs text-rose-400"></div>
    <div id="help" class="text-xs text-amber-300"></div>
  </section>

  <section class="card rounded-xl p-3">
    <div class="overflow-auto">
      <table class="w-full text-sm">
        <thead class="table-head uppercase text-xs sticky-head">
          <tr class="border-b border-slate-800">
            <th class="p-2 text-left">Message Type</th>
            <th class="p-2 text-left">Status</th>
            <th class="p-2 text-left">WhatsApp</th>
            <th class="p-2 text-left">Name</th>
            <th class="p-2 text-left">Surname</th>
            <th class="p-2 text-left">Number</th>
            <th class="p-2 text-left">Agency</th>
            <th class="p-2 text-left">Notes</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div class="flex items-center justify-between mt-3">
      <div class="text-xs text-slate-300">Showing 15 per page</div>
      <div class="flex items-center gap-2">
        <button id="prev" class="badge">Prev</button>
        <span id="page" class="text-sm"></span>
        <button id="next" class="badge">Next</button>
      </div>
    </div>
  </section>
</div>

<script>
const STATUS_OPTIONS=["To Contact","Whatsapp","Reply","Keen to meet","Cultivate","Invite to events","Not interested","No Whatsapp","Unsubscribe","Referred","Event Invite Sent","Event Invite Accepted"];
const PAGE=15;
const EXEC_LOCKED="https://script.google.com/macros/s/AKfycby981SXO1xO0xGWs-HkD2wGePSwRg1AbRFrbAQul8c2dirHhpssESwOTbb0Go2rHcjE/exec";

const qs=new URLSearchParams(location.search);
const $=id=>document.getElementById(id);
const E={ refresh:$("refresh"), q:$("q"), clear:$("clear"), f:$("f"), err:$("err"), help:$("help"), rows:$("rows"), total:$("total"), filtered:$("filtered"), prev:$("prev"), next:$("next"), page:$("page"), apiBadge:$("apiBadge") };

let all=[], view=[], page=1;

function getExec(){ return qs.get('api') || EXEC_LOCKED; }
function getGid(){ return qs.get('gid') || ""; }
function apiUrl(action, params={}){
  const u=new URL(getExec()); if(action) u.searchParams.set("action", action);
  const gid=getGid(); if(gid) u.searchParams.set("gid", gid);
  for(const [k,v] of Object.entries(params||{})) u.searchParams.set(k,v);
  u.searchParams.set("t", Date.now()); return u.toString();
}
async function jget(action, params={}){ const r=await fetch(apiUrl(action, params), {mode:'cors'}); if(!r.ok) throw new Error(r.status); return r.json(); }
async function jpost(action, payload={}){ const r=await fetch(apiUrl(), {method:'POST', body:JSON.stringify({action,payload}), mode:'cors'}); if(!r.ok) throw new Error(r.status); return r.json(); }

function opt(v,s){return `<option value="${v}"${s?' selected':''}>${v}</option>`}
function setPage(){ const max=Math.max(1,Math.ceil(view.length/PAGE)); if(page<1)page=1; if(page>max)page=max; $("page").textContent=`Page ${page} of ${max}`; $("prev").disabled=page<=1; $("next").disabled=page>=max; }
function pageSlice(){ const s=(page-1)*PAGE; return view.slice(s,s+PAGE); }
function rowId(r){ return r.rowNumber || (r.rowIndex!=null ? (r.rowIndex+2) : null); }

function parseWa(waLink){ try{ const u=new URL(waLink); return { phone:u.pathname.replace(/\\//g,'').trim(), text:u.searchParams.get('text')||'' }; }catch(_){ return { phone:'', text:'' }; } }

// NEW WINDOW every send (desktop-first)
function openWhatsAppInNewWindow(waLink){
  const {phone,text} = parseWa(waLink);
  const appUrl = `whatsapp://send?phone=${encodeURIComponent(phone)}&text=${encodeURIComponent(text)}`;
  const features = 'noopener,noreferrer,width=1080,height=900,left=80,top=60,menubar=yes,toolbar=yes,location=yes,status=no,scrollbars=yes,resizable=yes';

  let w=null;
  try{ w = window.open('about:blank','_blank',features); }catch(_){}
  if (w){
    try{ w.opener=null; }catch(_){}
    try{ w.location.href = appUrl; }catch(_){ try{ w.location = appUrl; }catch(__){} }
    setTimeout(()=>{ try{ w.location.href = waLink; }catch(__){} }, 1200);
    return false;
  }
  // Fallback if blocked
  const a=document.createElement('a'); a.href=appUrl; a.target='_blank'; a.rel='noopener noreferrer';
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>{ window.open(waLink,'_blank',features); }, 1200);
  return false;
}

async function changeStatus(r,newStatus,sel){ const rn=rowId(r); if(!rn) return; sel && (sel.disabled=true);
  try{ await jpost("updateSingleStatus", {rowNumber: rn, newStatus}); r.status=newStatus; } finally { sel && (sel.disabled=false); } }

function draw(){ E.rows.innerHTML=""; const rows=pageSlice(); if(!rows.length){E.rows.innerHTML='<tr><td class="p-3 text-slate-300" colspan="8">No rows.</td></tr>'; setPage(); return; }
  rows.forEach(r=>{ const tr=document.createElement("tr"); tr.className="border-b border-slate-800";
    const t1=document.createElement("td"); t1.className="p-2"; t1.innerHTML=`<span class="badge">${r.messageType||'Recruit'}</span>`;
    const t2=document.createElement("td"); t2.className="p-2"; t2.innerHTML=`<select class="select">${STATUS_OPTIONS.map(s=>`<option value="${s}"${s===(r.status||'')?' selected':''}>${s}</option>`).join('')}</select>`; const sel=t2.querySelector('select'); sel.onchange=()=>changeStatus(r, sel.value, sel);
    const t3=document.createElement("td"); t3.className="p-2"; const btn=document.createElement("button"); btn.className="btn"; btn.textContent="Send"; const ok=/^https:\\/\\/(wa\\.me|web\\.whatsapp\\.com|api\\.whatsapp\\.com)\\//.test(r.waLink||''); if(!ok) btn.disabled=true; btn.onclick=(e)=>{ e.preventDefault(); e.stopPropagation(); openWhatsAppInNewWindow(r.waLink); }; t3.appendChild(btn);
    const t4=document.createElement("td"); t4.className="p-2"; t4.textContent=r.name||'';
    const t5=document.createElement("td"); t5.className="p-2"; t5.textContent=r.surname||'';
    const t6=document.createElement("td"); t6.className="p-2"; t6.textContent=r.cell||'';
    const t7=document.createElement("td"); t7.className="p-2"; t7.textContent=r.agency||'';
    const t8=document.createElement("td"); t8.className="p-2"; const nb=document.createElement('button'); nb.className='badge'; nb.textContent='Edit'; nb.onclick=async()=>{ const v=prompt('Edit note for '+(r.name||''), r.notes||''); if(v===null) return; nb.disabled=true; try{ await jpost('updateNote', {rowNumber: rowId(r), note:v}); r.notes=v; draw(); } finally { nb.disabled=false; } }; t8.appendChild(nb);
    tr.append(t1,t2,t3,t4,t5,t6,t7,t8); E.rows.appendChild(tr);
  }); setPage(); }

function apply(reset=true){ const q=(E.q.value||'').toLowerCase().trim(); view=all.filter(r=>{ if(q && !(String(r.name||'').toLowerCase().includes(q)||String(r.surname||'').toLowerCase().includes(q)||String(r.agency||'').toLowerCase().includes(q))) return false; const f=E.f.value||''; if(f && f!==(r.status||'')) return false; return true; }); E.filtered.textContent=view.length; if(reset) page=1; }
async function load(){ E.err.textContent=''; E.help.textContent=''; try{ const status=(E.f.value||'').trim(); const js=await jget('recipients', status?{'status':status}:{}); all=js.recipients||[]; apply(true); draw(); const s=await jget('stats'); E.total.textContent=s.total||0; }catch(e){ E.err.textContent='Failed to fetch'; const url=apiUrl('stats'); E.help.innerHTML=`Open backend: <a class="link" target="_blank" rel="noopener" href="${url}">${url}</a>`; } }

document.addEventListener('DOMContentLoaded', async ()=>{
  E.f.innerHTML='<option value="">(All)</option>'+STATUS_OPTIONS.map(s=>opt(s,false)).join('');
  E.q.oninput=()=>apply();
  E.clear.onclick=()=>{E.q.value=''; apply();};
  E.f.onchange=()=>load();
  E.prev.onclick=()=>{page--; draw();};
  E.next.onclick=()=>{page++; draw();};
  E.refresh.onclick=()=>load();

  const ex = getExec(); try{ E.apiBadge.textContent=(new URL(ex)).host; }catch(_){ E.apiBadge.textContent=ex; }
  E.apiBadge.classList.remove('hidden');

  await load();
});
</script>
</body></html>
