<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recruit 101</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0b0b0b">
  <link rel="icon" href="./assets/icon.png">
  <style>
    html,body { background:#0b0b0b; color:#e5e7eb; }
    .card { background:#111827; border:1px solid #1f2937; }
    select, input { background:#0b0b0b; border:1px solid #374151; }
    a.btn, button.btn { background:#e11d48; color:white; }
    .muted { color:#9ca3af; }
    .chip { background:#1f2937; border:1px solid #374151; padding:6px 10px; border-radius:9999px; cursor:pointer; user-select:none; }
    .chip.active { background:#e11d48; color:white; border-color:#e11d48; }
    .btn-lite { background:#374151; color:#e5e7eb; }
    .badge { background:#374151; color:#e5e7eb; padding:2px 8px; border-radius:9999px; font-size:12px; }
    table th, table td { white-space: nowrap; }
    .pill { padding:2px 8px; border-radius:9999px; border:1px solid #374151; }
    .kbd { background:#1f2937; border:1px solid #374151; padding:1px 6px; border-radius:6px; font-size:11px; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-7xl mx-auto p-4 space-y-4">

    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="./assets/logo.png" alt="Recruit 101" class="h-10 w-auto rounded-md" />
        <div>
          <h1 class="text-xl font-semibold">Recruit 101</h1>
          <div class="text-xs muted">v12.2</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm">After-send status</label>
        <select id="afterStatus" class="rounded-md p-2"></select>
        <button id="btnRefresh" class="btn px-3 py-2 rounded-md">Refresh</button>
      </div>
    </header>

    <!-- Totals + status chips -->
    <section class="card rounded-xl p-3 space-y-3">
      <div class="flex items-center gap-3 flex-wrap">
        <div class="pill text-xs">Total: <span id="totalCount">0</span></div>
        <div class="pill text-xs">Filtered: <span id="resultCount">0</span></div>
        <div id="statusMsg" class="text-xs muted"></div>
      </div>
      <div id="statusBar" class="flex gap-2 overflow-x-auto pb-1"></div>

      <!-- Search Row -->
      <div class="grid md:grid-cols-3 gap-2 items-end">
        <div class="col-span-2">
          <label class="text-sm block mb-1">Search (Name or Agency)</label>
          <div class="flex gap-2">
            <input id="q" class="rounded-md p-2 w-full" placeholder="Type to filterâ€¦ (e.g. Ndlovu or 'Explore')" />
            <span class="kbd">Enter</span>
          </div>
        </div>
        <div>
          <label class="text-sm block mb-1">Status filter</label>
          <select id="fStatus" class="rounded-md p-2 w-full"></select>
        </div>
      </div>
    </section>

    <!-- Table -->
    <section class="card rounded-xl p-3">
      <div class="overflow-auto">
        <table class="w-full text-sm">
          <thead class="text-xs uppercase muted">
            <tr class="border-b border-neutral-800">
              <th class="p-2 text-left">Message Type</th>
              <th class="p-2 text-left">Status</th>
              <th class="p-2 text-left">WhatsApp</th>
              <th class="p-2 text-left">Name</th>
              <th class="p-2 text-left">Surname</th>
              <th class="p-2 text-left">Number</th>
              <th class="p-2 text-left">Agency</th>
              <th class="p-2 text-left">Notes</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex items-center justify-between mt-3">
        <div class="text-xs muted">Showing 15 per page</div>
        <div class="flex items-center gap-2">
          <button id="prevPage" class="btn-lite px-3 py-2 rounded-md">Prev</button>
          <span id="pageInfo" class="text-sm"></span>
          <button id="nextPage" class="btn-lite px-3 py-2 rounded-md">Next</button>
        </div>
      </div>
    </section>
  </div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxPApgm_UeIU8rYA0TmqpSypOEUnLjSY86othzkrSBFvYcnNkjz54vgxhXcvotfuFoSCw/exec";
  const STATUS_OPTIONS = ["To Contact", "Whatsapp", "Reply", "Keen to meet", "Cultivate", "Invite to events", "Not interested", "No Whatsapp", "Unsubscribe", "Referred", "Event Invite Sent", "Event Invite Accepted"];
  const DEFAULT_AFTER_SEND = "Event Invite Sent";

  // Forward gid from the page URL (example: index.html?gid=123456789)
  const GID = new URLSearchParams(location.search).get('gid');

  const PAGE_SIZE = 15;
  let currentPage = 1;
  let rowsAll = [];   // unfiltered (latest fetch)
  let rowsView = [];  // filtered view
  let counts = {};    // status counts

  // Elements
  const el = (id) => document.getElementById(id);
  const E = {
    afterStatus: el('afterStatus'),
    btnRefresh: el('btnRefresh'),
    statusBar: el('statusBar'),
    statusMsg: el('statusMsg'),
    totalCount: el('totalCount'),
    resultCount: el('resultCount'),
    q: el('q'),
    fStatus: el('fStatus'),
    rows: el('rows'),
    pageInfo: el('pageInfo'),
    prevPage: el('prevPage'),
    nextPage: el('nextPage')
  };

  function optHtml(v, sel){ return '<option value="'+v.replaceAll('"','&quot;')+'" '+(sel?'selected':'')+'>'+v+'</option>'; }

  function initControls(){
    // After-send status selector
    E.afterStatus.innerHTML = STATUS_OPTIONS.map(s => optHtml(s, s===DEFAULT_AFTER_SEND)).join('');
    // Status filter dropdown (with All)
    E.fStatus.innerHTML = '<option value="">(All)</option>' + STATUS_OPTIONS.map(s => optHtml(s, false)).join('');
  }

  function buildUrl(action){
    const url = new URL(WEB_APP_URL);
    if (action) url.searchParams.set('action', action);
    if (GID) url.searchParams.set('gid', GID);
    url.searchParams.set('t', Date.now());
    return url;
  }

  // Fetch stats (with client fallback)
  async function fetchStats(){
    try {
      const url = buildUrl('stats');
      const res = await fetch(url.toString());
      const js = await res.json();
      if (js && js.byStatus) {
        counts = js.byStatus;
        E.totalCount.textContent = js.total || 0;
        renderStatusChips();
        return;
      }
    } catch(e){ /* ignore */ }
    // Fallback: compute from current rowsAll
    counts = {};
    rowsAll.forEach(r => { const k = r.status || ''; counts[k] = (counts[k]||0)+1; });
    E.totalCount.textContent = rowsAll.length;
    renderStatusChips();
  }

  function renderStatusChips(){
    const order = [''].concat(STATUS_OPTIONS); // include blank as "All"
    const chips = [];
    const total = Object.values(counts).reduce((a,b)=>a+b,0);
    chips.push({ key:'', label:'All', count: total });
    STATUS_OPTIONS.forEach(s => chips.push({ key:s, label:s, count:(counts[s]||0) }));

    const selectedKey = E.fStatus.value || '';
    E.statusBar.innerHTML = chips.map(ch => {
      const active = (selectedKey === ch.key);
      return '<span class="chip '+(active?'active':'')+'" data-key="'+ch.key.replaceAll('"','&quot;')+'">'+ch.label+': '+ch.count+'</span>';
    }).join('');

    Array.from(E.statusBar.querySelectorAll('.chip')).forEach(ch => {
      ch.addEventListener('click', () => {
        const key = ch.getAttribute('data-key');
        E.fStatus.value = key;
        applyFilters();
      });
    });
  }

  // Fetch recipients from server with filters (server-side) then apply client search
  async function loadRows(){
    const url = buildUrl('recipients');
    const status = (E.fStatus.value || '').trim();
    if (status) url.searchParams.set('status', status);
    const res = await fetch(url.toString());
    const js = await res.json();
    rowsAll = js.recipients || [];
    await fetchStats(); // keep counts in sync
    applyFilters(false); // do not reload again
  }

  // Apply filters: client search across name or agency + current status dropdown selection already used server-side
  function applyFilters(reload=true){
    const q = (E.q.value || '').trim().toLowerCase();
    rowsView = rowsAll.filter(r => {
      if (!q) return true;
      return (String(r.name||'').toLowerCase().includes(q) ||
              String(r.surname||'').toLowerCase().includes(q) ||
              String(r.agency||'').toLowerCase().includes(q));
    });
    E.resultCount.textContent = rowsView.length;
    currentPage = 1;
    renderTable();
    updatePagerUI();
    if (reload) loadRows(); // optional back-sync
  }

  function pageSlice(){
    const start = (currentPage - 1) * PAGE_SIZE;
    return rowsView.slice(start, start + PAGE_SIZE);
  }
  function updatePagerUI(){
    const totalPages = Math.max(1, Math.ceil(rowsView.length / PAGE_SIZE));
    if (currentPage < 1) currentPage = 1;
    if (currentPage > totalPages) currentPage = totalPages;
    E.pageInfo.textContent = 'Page ' + currentPage + ' of ' + totalPages;
    E.prevPage.disabled = (currentPage <= 1);
    E.nextPage.disabled = (currentPage >= totalPages);
  }

  async function postAction(action, payload){
    const url = buildUrl('');
    const res = await fetch(url.toString(), {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action, payload })
    });
    const js = await res.json();
    if (js && js.result === 'error') throw new Error(js.message||'Server error');
    return js || { result:'ok' };
  }
  async function updateStatus(rowIndex, newStatus){
    return postAction('updateSingleStatus', { rowIndex, newStatus });
  }
  async function updateNote(rowIndex, note){
    return postAction('updateNote', { rowIndex, note });
  }

  function selectHtml(opts, current) {
    let html = '<select class="rounded-md p-1">';
    for (const o of opts) {
      const sel = (o === current) ? 'selected' : '';
      html += '<option value="'+o.replaceAll('"','&quot;')+'" '+sel+'>'+o+'</option>';
    }
    html += '</select>';
    return html;
  }

  function renderTable(){
    E.rows.innerHTML = '';
    const slice = pageSlice();
    slice.forEach(r => {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-neutral-800';

      // Message Type (read-only)
      const tdType = document.createElement('td'); tdType.className='p-2';
      tdType.innerHTML = '<span class="badge">'+(r.messageType || 'Recruit')+'</span>';

      // Status (editable)
      const tdStatus = document.createElement('td'); tdStatus.className='p-2';
      tdStatus.innerHTML = selectHtml(STATUS_OPTIONS, r.status || '');
      const selStatus = tdStatus.querySelector('select');
      selStatus.addEventListener('change', async (e) => {
        selStatus.disabled = true;
        try { await updateStatus(r.rowIndex, e.target.value); } catch(e){ console.error(e); }
        await loadRows();
      });

      // WhatsApp button (window.open for reliability + validation)
      const tdWA = document.createElement('td'); tdWA.className='p-2';
      const btnSend = document.createElement('button'); btnSend.className='btn px-3 py-1 rounded-md'; btnSend.textContent='Send';
      const link = r.waLink || "";
      const valid = /^https:\/\/(wa\.me|api\.whatsapp\.com)\//.test(link);
      if (!link || !valid) { btnSend.disabled = true; btnSend.title = 'No valid WhatsApp link'; }
      btnSend.addEventListener('click', async () => {
        if (!link || !valid) { alert('No valid WhatsApp link for this row.'); return; }
        // Open WA first (user gesture)
        try { window.open(link, '_blank', 'noopener'); } catch(e){ /* ignore */ }
        // Then update status
        const st = E.afterStatus ? E.afterStatus.value : DEFAULT_AFTER_SEND;
        try { await updateStatus(r.rowIndex, st); } catch(e){ console.error(e); }
        await loadRows();
      });
      tdWA.appendChild(btnSend);

      // Name, Surname, Number, Agency
      const tdName = document.createElement('td'); tdName.className='p-2'; tdName.textContent = r.name || '';
      const tdSur  = document.createElement('td'); tdSur.className='p-2'; tdSur.textContent  = r.surname || '';
      const tdNum  = document.createElement('td'); tdNum.className='p-2'; tdNum.textContent  = r.cell || '';
      const tdAg   = document.createElement('td'); tdAg.className='p-2'; tdAg.textContent   = r.agency || '';

      // Notes
      const tdNote = document.createElement('td'); tdNote.className='p-2';
      const btnN = document.createElement('button'); btnN.className='btn-lite px-2 py-1 rounded-md'; btnN.textContent='Edit';
      btnN.addEventListener('click', async () => {
        const newNote = prompt('Edit note for '+(r.name||''), r.notes || '');
        if (newNote === null) return; // cancelled
        btnN.disabled = true;
        try { await updateNote(r.rowIndex, newNote); } catch (e) { console.error(e); }
        await loadRows();
      });
      tdNote.appendChild(btnN);

      tr.appendChild(tdType);
      tr.appendChild(tdStatus);
      tr.appendChild(tdWA);
      tr.appendChild(tdName);
      tr.appendChild(tdSur);
      tr.appendChild(tdNum);
      tr.appendChild(tdAg);
      tr.appendChild(tdNote);

      E.rows.appendChild(tr);
    });
  }

  // Debounce for search
  function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
  const onSearchChanged = debounce(()=>applyFilters(), 250);

  // Wire events
  document.addEventListener('DOMContentLoaded', async () => {
    initControls();
    E.q.addEventListener('input', onSearchChanged);
    E.fStatus.addEventListener('change', () => loadRows());
    E.btnRefresh.addEventListener('click', async () => { await loadRows(); });

    // First load
    await loadRows();
  });
</script>
</body>
</html>
