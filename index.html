<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KW Explore — WhatsApp Sender (Simple)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#111827">
  <link rel="icon" href="./assets/icon.png">
  <style>
    html,body { background:#0b0b0b; color:#e5e7eb; }
    .card { background:#1f2937; }
    select, input { background:#0b0b0b; }
    a.btn, button.btn { background:#e11d48; color:white; }
    .muted { color:#9ca3af; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto p-4 space-y-4">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="./assets/logo.png" alt="KW Explore" class="h-10 w-auto rounded-md" />
        <h1 class="text-xl font-semibold">WhatsApp Sender — Simple</h1>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm">After-send status</label>
        <select id="afterStatus" class="rounded-md p-2">
          <option  value="To Contact">To Contact</option><option selected value="Whatsapp">Whatsapp</option><option  value="Reply">Reply</option><option  value="Keen to meet">Keen to meet</option><option  value="Cultivate">Cultivate</option><option  value="Invite to events">Invite to events</option><option  value="Not interested">Not interested</option><option  value="No Whatsapp">No Whatsapp</option><option  value="Unsubscribe">Unsubscribe</option><option  value="Referred">Referred</option>
        </select>
        <button id="btnRefresh" class="btn px-3 py-2 rounded-md">Refresh</button>
      </div>
    </header>

    <section class="card rounded-xl p-3">
      <div class="overflow-auto">
        <table class="w-full text-sm">
          <thead class="text-xs uppercase muted">
            <tr class="border-b border-neutral-700">
              <th class="p-2 text-left">Name</th>
              <th class="p-2 text-left">Cell</th>
              <th class="p-2 text-left">Message Type</th>
              <th class="p-2 text-left">WhatsApp</th>
              <th class="p-2 text-left">Status</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <p class="muted text-xs mt-2">Tip: Change the Message Type first, then click Send.</p>
    </section>
  </div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxIJc_p_lX9SdQGAcinR_HjLcbey1l9eum3vMM9_bmHz1rrFwa0R_53FlfXLvK2jqPBsQ/exec";
  const MESSAGE_TYPES = ["Recruit", "Event 1 - Win Win"];

  const el = id => document.getElementById(id);
  let data = [];

  async function fetchRecipients() {
    const url = new URL(WEB_APP_URL);
    url.searchParams.set('action','recipients');
    const res = await fetch(url.toString());
    const js = await res.json();
    data = js.recipients || [];
    render();
  }

  async function setMessageType(rowIndex, newType) {
    await fetch(WEB_APP_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        action: 'updateMessageType',
        payload: { rowIndex, newType }
      })
    });
  }

  async function setStatus(rowIndex, newStatus) {
    await fetch(WEB_APP_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        action: 'updateSingleStatus',
        payload: { rowIndex, newStatus }
      })
    });
  }

  function typeSelectHtml(current) {
    const opts = MESSAGE_TYPES.map(t => `<option value="${t}" ${t===current?'selected':''}>${t}</option>`).join('');
    return `<select class="rounded-md p-1 typeSel">${opts}</select>`;
  }

  function render() {
    const tb = el('rows'); tb.innerHTML = '';
    data.forEach((r, idx) => {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-neutral-800';
      const sendHtml = r.waLink ? `<a class="btn px-3 py-1 rounded-md" target="_blank" href="${r.waLink}">Send</a>` : '<span class="text-xs muted">No link</span>';
      tr.innerHTML = `
        <td class="p-2">${[r.name, r.surname].filter(Boolean).join(' ')}</td>
        <td class="p-2">${r.cell || ''}</td>
        <td class="p-2">${typeSelectHtml(r.messageType || 'Recruit')}</td>
        <td class="p-2">${sendHtml}</td>
        <td class="p-2">${r.status || ''}</td>
      `;
      const sel = tr.querySelector('.typeSel');
      sel.addEventListener('change', async (e) => {
        const newType = e.target.value;
        sel.disabled = true;
        await setMessageType(r.rowIndex, newType);
        await fetchRecipients(); // pull the rebuilt WA_LINK/WA_MSG
      });
      const sendA = tr.querySelector('a.btn');
      if (sendA) {
        sendA.addEventListener('click', async () => {
          const st = el('afterStatus').value || 'Whatsapp';
          try { await setStatus(r.rowIndex, st); } catch (e) {}
        });
      }
      tb.appendChild(tr);
    });
  }

  el('btnRefresh').onclick = fetchRecipients;
  fetchRecipients();
</script>
</body>
</html>
